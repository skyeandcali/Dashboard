<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Caliâ€™s Party â€” Dashboard (Mobile Optimized)</title>
  <style>
    :root{
      --ink:#1f2328; --muted:#5d6b7a; --card:#fff; --bg:#fafafa;
      --chip:#eff3ff; --chip-b:#c7d2fe; --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;-webkit-text-size-adjust:100%}
    header{position:sticky;top:0;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px 16px;z-index:5}
    h1{margin:0;font-size:clamp(1rem,2.5vw,1.2rem)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input{padding:12px;border-radius:12px;border:1px solid #e5e7eb;min-width:220px;flex:1}
    button{padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;touch-action:manipulation}
    button:active{transform:translateY(1px)}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;font-size:.9rem}
    #error{color:#b00;margin:.5rem 0}
    .empty{opacity:.7;margin:.5rem 0 0}

    /* Table baseline */
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    th{background:#f7f7ff;font-weight:600}
    td.r, th.r {text-align:right;white-space:nowrap}

    /* Horizontal scroll on mid screens to avoid squish */
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px}

    /* Mobile card view: convert table rows into cards with labels */
    @media (max-width: 700px){
      table thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tr{background:#fff;border:1px solid #eee;border-radius:12px;margin-bottom:10px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
      td{border:none;border-top:1px solid #f2f2f2;padding:10px 12px}
      td:first-child{border-top:none;border-radius:12px 12px 0 0;padding-top:12px}
      td:last-child{border-radius:0 0 12px 12px;padding-bottom:12px}
      td::before{
        content:attr(data-label);
        display:block;
        font-size:.85rem;
        color:var(--muted);
        margin-bottom:4px;
      }
      .r{text-align:left;white-space:normal}
      .row{gap:8px}
      input{min-width:140px}
      button{padding:10px 12px}
      .chip{font-size:.85rem}
    }

    /* Improve tap targets */
    @media (pointer:coarse){
      button, input{font-size:16px}
    }
  </style>
</head>
<body>
  <header><h1>ðŸŽ‚ Caliâ€™s Party List</h1></header>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <input id="q" placeholder="Search guestâ€¦" autocomplete="off" />
        <button class="primary" id="refresh">Refresh</button>
        <button id="export">Export CSV</button>
      </div>
      <div class="chips">
        <span class="chip" id="project">Event: â€¦</span>
        <span class="chip" id="viewsCount">Views: 0</span>
        <span class="chip" id="rsvpsCount">RSVPs: 0</span>
        <span class="chip" id="allergiesCount">Allergies: 0</span>
      </div>
      <div id="error"></div>
      <p id="empty" class="empty" style="display:none">No records yet.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Guest</th>
              <th>Allergies / Dietary</th>
              <th class="r">Last Viewed</th>
              <th class="r">Total Views</th>
              <th class="r">Last RSVP</th>
              <th class="r">RSVP Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // Firebase config (from your project)
    const firebaseConfig = {
      apiKey: "AIzaSyDtC4RvoYxotfxDyp32gjeFediehdaWrLs",
      authDomain: "cali-s-birthday.firebaseapp.com",
      projectId: "cali-s-birthday",
      storageBucket: "cali-s-birthday.firebasestorage.app",
      messagingSenderId: "68111770262",
      appId: "1:68111770262:web:bda1b19bf7daffd59bd8b7",
      measurementId: "G-4S02N4P70L"
    };
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getFirestore(app);
    document.getElementById("project").textContent = "Project: " + firebaseConfig.projectId;

    const qViews = query(collection(db, "views"), orderBy("ts","desc"));
    const qRsvps = query(collection(db, "rsvps"), orderBy("ts","desc"));
    const qAllergies = query(collection(db, "allergies"), orderBy("ts","desc"));

    const state = { views: [], rsvps: [], allergies: [] };

    const toMillis = (ts)=>{
      if (!ts) return 0;
      try { return ts.toMillis ? ts.toMillis() : (ts.seconds ? ts.seconds*1000 : (new Date(ts)).getTime()); }
      catch(e){ return 0; }
    };
    const fmt = (ts)=>{
      if (!ts) return "";
      try {
        const d = ts.toDate ? ts.toDate() : (ts.seconds ? new Date(ts.seconds*1000) : new Date(ts));
        return d.toLocaleString();
      } catch(e){ return ""; }
    };

    function rebuild(){
      const map = new Map();
      const ensure = (name)=>{
        const key = (name||"(unknown)").trim();
        if (!map.has(key)) map.set(key, { name:key, allergy:"", lastView:null, viewCount:0, lastChoice:"", rsvpTime:null });
        return map.get(key);
      };

      for (const v of state.views){
        const row = ensure(v.to);
        row.viewCount += 1;
        if (!row.lastView || toMillis(v.ts) > toMillis(row.lastView)) row.lastView = v.ts || row.lastView;
        if (!row.allergy && v.allergy) row.allergy = v.allergy;
      }
      for (const a of state.allergies){
        const row = ensure(a.to);
        if (a.allergy) row.allergy = a.allergy;
      }
      for (const r of state.rsvps){
        const row = ensure(r.to);
        if (!row.rsvpTime || toMillis(r.ts) > toMillis(row.rsvpTime)){
          row.lastChoice = r.choice || row.lastChoice;
          row.rsvpTime  = r.ts || row.rsvpTime;
        }
        if (r.allergy && !row.allergy) row.allergy = r.allergy;
      }

      const q = document.getElementById("q").value.toLowerCase();
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      const rows = [...map.values()].sort((a,b)=> a.name.localeCompare(b.name));
      for (const row of rows){
        if (q && !row.name.toLowerCase().includes(q)) continue;
        const tr = document.createElement("tr");

        // Desktop cells
        tr.innerHTML = \`
          <td data-label="Guest">\${row.name}</td>
          <td data-label="Allergies / Dietary">\${row.allergy||""}</td>
          <td class="r" data-label="Last Viewed">\${fmt(row.lastView)}</td>
          <td class="r" data-label="Total Views">\${row.viewCount}</td>
          <td class="r" data-label="Last RSVP">\${row.lastChoice||""}</td>
          <td class="r" data-label="RSVP Time">\${fmt(row.rsvpTime)}</td>\`;

        tbody.appendChild(tr);
      }

      document.getElementById("viewsCount").textContent = "Views: " + state.views.length;
      document.getElementById("rsvpsCount").textContent = "RSVPs: " + state.rsvps.length;
      document.getElementById("allergiesCount").textContent = "Allergies: " + state.allergies.length;
      document.getElementById("empty").style.display = tbody.children.length ? "none" : "block";
    }

    async function fallbackLoad(){
      const [v, r, a] = await Promise.all([
        getDocs(collection(db,"views")),
        getDocs(collection(db,"rsvps")),
        getDocs(collection(db,"allergies"))
      ]);
      state.views = v.docs.map(d=>d.data());
      state.rsvps = r.docs.map(d=>d.data());
      state.allergies = a.docs.map(d=>d.data());
    }

    async function refreshOnce(){
      try {
        const [v, r, a] = await Promise.all([
          getDocs(qViews),
          getDocs(qRsvps),
          getDocs(qAllergies)
        ]);
        state.views = v.docs.map(d=>d.data());
        state.rsvps = r.docs.map(d=>d.data());
        state.allergies = a.docs.map(d=>d.data());
        document.getElementById("error").textContent = "";
      } catch(err){
        try { await fallbackLoad(); document.getElementById("error").textContent = "Loaded without ordering."; }
        catch(err2){
          document.getElementById("error").textContent = "Could not load data â€” check project or collection names. " + (err2?.message||err2);
          console.error(err2);
        }
      }
      rebuild();
    }

    function attachStreams(){
      try {
        onSnapshot(qViews,  s=>{ state.views = s.docs.map(d=>d.data()); rebuild(); },  async ()=>{ await fallbackLoad(); rebuild(); });
        onSnapshot(qRsvps,  s=>{ state.rsvps = s.docs.map(d=>d.data()); rebuild(); }, async ()=>{ await fallbackLoad(); rebuild(); });
        onSnapshot(qAllergies, s=>{ state.allergies = s.docs.map(d=>d.data()); rebuild(); }, async ()=>{ await fallbackLoad(); rebuild(); });
      } catch (err) {
        document.getElementById("error").textContent = "Realtime stream failed. " + (err?.message||err);
        console.error(err);
      }
    }

    // Controls
    document.getElementById("q").addEventListener("input", rebuild);
    document.getElementById("refresh").addEventListener("click", refreshOnce);
    document.getElementById("export").addEventListener("click", ()=>{
      const rows = [["Guest","Allergies / Dietary","Last Viewed","Total Views","Last RSVP","RSVP Time"]];
      document.querySelectorAll("#tbl tbody tr").forEach(tr=>{
        const cols = [...tr.children].map(td => \"\"\"".replace(/./,''));
      });
      // Proper export
      const rows2 = [["Guest","Allergies / Dietary","Last Viewed","Total Views","Last RSVP","RSVP Time"]];
      document.querySelectorAll("#tbl tbody tr").forEach(tr=>{
        const cols = Array.from(tr.children).map(td=> \`"\${(td.textContent||"").replace(/"/g,'""')}"\`);
        rows2.push(cols);
      });
      const csv = rows2.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "guest_activity.csv";
      a.click();
    });

    // Init
    attachStreams();
    refreshOnce();
  </script>
</body>
</html>
